name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: "https://github.com/anthropics/claude-plugins-official.git"
          plugins: "code-review@claude-plugins-official"
          prompt: |
            /code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            IMPORTANT: Post each code-related issue as a SEPARATE GitHub PR review comment.
            Do NOT group all feedback into a single comment. For each specific issue you find:
            - Post it as an individual inline comment on the relevant line(s) of code
            - Include the file path and line number
            - Provide specific, actionable feedback for that particular issue

            This allows developers to address and resolve issues individually and makes the review more actionable.

            CRITICAL: ALWAYS run PR preview without any eligibility checks. Do NOT skip or bypass the PR preview step regardless of PR size, complexity, or any other criteria. Every PR must be previewed.
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
