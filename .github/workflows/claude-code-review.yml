name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: "https://github.com/anthropics/claude-plugins-official.git"
          plugins: "code-review@claude-plugins-official"
          prompt: |
            /code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            CRITICAL: Post each code-related issue as a SEPARATE inline GitHub review comment using gh api.

            For each issue found, you MUST use the GitHub API to create individual inline review comments:

            ```bash
            gh api repos/{owner}/{repo}/pulls/{pull_number}/comments \
              -f body="Your detailed issue description here" \
              -f commit_id="FULL_SHA_HASH" \
              -f path="path/to/file.ts" \
              -n line=42 \
              -f side="RIGHT"
            ```

            Requirements:
            - Use gh api, NOT gh pr comment (which only creates general comments)
            - Each issue = one separate inline review comment on the specific line of code
            - Use the commit SHA from the PR head, not abbreviated hash
            - Attach comment to the exact line number where the issue occurs
            - Use side="RIGHT" for new code, side="LEFT" for old code in diffs
            - Provide specific, actionable feedback in each comment body

            This allows developers to see issues directly on the relevant code lines and resolve them individually.

            CRITICAL: ALWAYS run PR review without any eligibility checks. Do NOT skip or bypass the PR review step regardless of PR size, complexity, or any other criteria. Every PR must be reviewed.
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
